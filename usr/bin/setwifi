#!/bin/sh

# Fungsi untuk memaparkan menu dan mendapatkan pilihan bernombor
get_choice_from_menu() {
    local prompt=$1
    local options=$2
    local result_var=$3
    local choice
    local i=1

    echo "--- $prompt ---"
    for option in $options; do
        echo "$i. $option"
        i=$((i+1))
    done

    while true; do
        echo -n "Masukkan nombor pilihan: "
        read choice

        # Check jika pilihan adalah nombor dan berada dalam julat yang sah
        if [ "$choice" -ge 1 ] && [ "$choice" -lt "$i" ] 2>/dev/null; then
            # Dapatkan nilai sebenar dari senarai pilihan
            selected_value=$(echo "$options" | awk -v num="$choice" '{print $num}')
            eval "$result_var='$selected_value'"
            return
        else
            echo "❌ Pilihan tidak sah. Sila masukkan nombor antara 1 hingga $((i-1))."
        fi
    done
}

# Tanya SSID
echo -n "Nama WiFi (SSID): "
read ap_ssid
if [ -z "$ap_ssid" ]; then
    echo "❌ SSID tak boleh kosong!"
    exit 1
fi

# Tanya Password
echo -n "Password (Enter kalau nak open): "
read ap_key

# Set encryption ikut ada password atau tak
if [ -z "$ap_key" ]; then
    encryption="none"
else
    encryption="psk2"
fi

# ===================== Pilihan untuk 5GHz ============================================
get_choice_from_menu "Pilih Channel 5GHz" "36 100 149" channel_5g
get_choice_from_menu "Pilih HT Mode 5GHz" "HE20 HE40 HE80 HE160" htmode_5g

# ===================== Pilihan untuk 2.4GHz ============================================
get_choice_from_menu "Pilih Channel 2.4GHz" "1 2 3 4 5 6 7 8 9 10 11 13" channel_2g
get_choice_from_menu "Pilih HT Mode 2.4GHz" "HE20 HE40" htmode_2g

# ===================== Konfigurasi Wireless 5GHz ============================================
uci set wireless.radio0=wifi-device
uci set wireless.radio0.type='mac80211'
uci set wireless.radio0.path='platform/soc@0/c000000.wifi'
uci set wireless.radio0.band='5g'
uci set wireless.radio0.channel="$channel_5g"
uci set wireless.radio0.htmode="$htmode_5g"
uci set wireless.radio0.disabled='0'
uci set wireless.radio0.country='SG'
uci set wireless.radio0.txpower='30'

uci set wireless.default_radio0=wifi-iface
uci set wireless.default_radio0.device='radio0'
uci set wireless.default_radio0.network='lan'
uci set wireless.default_radio0.mode='ap'
uci set wireless.default_radio0.ssid="$ap_ssid-5Ghz"
uci set wireless.default_radio0.encryption="$encryption"
[ "$encryption" != "none" ] && uci set wireless.default_radio0.key="$ap_key"

# ===================== Konfigurasi Wireless 2.4GHz ============================================
uci set wireless.radio1=wifi-device
uci set wireless.radio1.type='mac80211'
uci set wireless.radio1.path='platform/soc@0/c000000.wifi+1'
uci set wireless.radio1.band='2g'
uci set wireless.radio1.channel="$channel_2g"
uci set wireless.radio1.htmode="$htmode_2g"
uci set wireless.radio1.disabled='0'
uci set wireless.radio1.country='SG'
uci set wireless.radio0.txpower='30'

uci set wireless.default_radio1=wifi-iface
uci set wireless.default_radio1.device='radio1'
uci set wireless.default_radio1.network='lan'
uci set wireless.default_radio1.mode='ap'
uci set wireless.default_radio1.ssid="$ap_ssid-2Ghz"
uci set wireless.default_radio1.encryption="$encryption"
[ "$encryption" != "none" ] && uci set wireless.default_radio1.key="$ap_key"

uci commit wireless
wifi reload

echo "✅ Dah set WiFi: ${ap_ssid}-2Ghz & ${ap_ssid}-5Ghz"
echo "---"
echo "5G: Channel ${channel_5g}, HT Mode ${htmode_5g}"
echo "2.4G: Channel ${channel_2g}, HT Mode ${htmode_2g}"
[ "$encryption" = "none" ] && echo "⚠️  WiFi OPEN (takde password!)"
