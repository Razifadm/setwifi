#!/bin/sh
#wget -O /tmp/updatemm https://raw.githubusercontent.com/Razifadm/radu/ipk/usr/bin/updatemm && chmod +x /tmp/updatemm && /tmp/updatemm

# ==========================================================
# RG500QE Module Firmware Flasher Script
# Allows the user to select between versions 01.200 or 02.200
# ==========================================================

# ========= URL & FILE LOCATION CONFIGURATION =========
MODULE_URL_1_200="https://github.com/Razifadm/radu/releases/download/Module/RG500QEAAAR13A01M4G_01.200.01.200.zip"
MODULE_URL_2_200="https://github.com/Razifadm/radu/releases/download/module2/RG500QEAAAR13A01M4G_02.200.02.200.zip"
QFIRE_URL="https://raw.githubusercontent.com/Razifadm/radu/ipk/QFirehose"

MODULE_ZIP="/tmp/module.zip"
QFIRE="/tmp/QFirehose"
UNZIP_DIR="/tmp/module_files" 
# ==================================================

## ‚öôÔ∏è Module Version Selection
echo "Script Made By @Raducksijaa"
echo "PROCEED AT YOU OWN RISK!!"
echo "I'M NOT RESPONSIBLE FOR ANY DAMAGE!!"
echo ""
echo "=================================="
echo "  CHOOSE MODULE VERSION"
echo "=================================="
echo "1) RG500QEAAAR13A01M4G_**01.200**"
echo "2) RG500QEAAAR13A01M4G_**02.200**"
echo "q) EXIT"
echo "----------------------------------"
read -p "Enter your choice (1/2/q): " CHOICE

case "$CHOICE" in
    1)
        MODULE_URL="$MODULE_URL_1_200"
        echo "‚úÖ Version 01.200 selected."
        ;;
    2)
        MODULE_URL="$MODULE_URL_2_200"
        echo "‚úÖ Version 02.200 selected."
        ;;
    [Qq])
        echo "Exiting script."
        exit 0
        ;;
    *)
        echo "‚ùå Invalid choice. Exiting script."
        exit 1
        ;;
esac

# ‚¨áÔ∏è Download Process
echo ""
echo "## ‚¨áÔ∏è Downloading Firmware and QFirehose"

# Download module ZIP file
wget -O "$MODULE_ZIP" "$MODULE_URL" >/dev/null 2>&1
WGET_EXIT_CODE=$? 

# Download QFirehose
echo "üì• Downloading QFirehose binary..."
wget -O "$QFIRE" "$QFIRE_URL" >/dev/null 2>&1

# üì¶ Unzip Installation
echo "## üì¶ Validating Packages"
# Check unzip installed or install
if ! command -v unzip >/dev/null 2>&1; then
    echo "üì¶ 'unzip' not found. Attempting installation via opkg..."
    opkg update >/dev/null 2>&1
    opkg install unzip >/dev/null 2>&1
fi

# ‚ö†Ô∏è File Validation
echo "## ‚ö†Ô∏è Validating Downloaded Files"

# Validate downloaded module
if [ "$WGET_EXIT_CODE" -ne 0 ] || [ ! -s "$MODULE_ZIP" ]; then
    echo "‚ùå ERROR: Firmware failed to download or is empty from $MODULE_URL"
    rm -f "$MODULE_ZIP"
    exit 1
fi

# Validate QFirehose
if [ ! -s "$QFIRE" ]; then
    echo "‚ùå ERROR: QFirehose binary not found or failed to download."
    rm -f "$QFIRE"
    exit 1
fi

# Make QFirehose executable
chmod +x "$QFIRE"

# üöÄ Module Installation
echo "## üöÄ Extracting and Flashing Module"

# Ensure the UNZIP_DIR is clean and exists
rm -rf "$UNZIP_DIR"
mkdir -p "$UNZIP_DIR"
echo "üìÇ Extracting files to $UNZIP_DIR..."
unzip -o "$MODULE_ZIP" -d "$UNZIP_DIR" >/dev/null 2>&1

echo ""
echo "## üö® STARTING FLASHING PROCESS!!"
echo "## ‚ö†Ô∏è DO NOT POWER OFF THE DEVICE!!"
"$QFIRE" -f "$UNZIP_DIR"
FLASH_EXIT_CODE=$?
echo "QFirehose Exit Code: $FLASH_EXIT_CODE"

# üßπ Cleanup
echo ""
echo "## üßπ CLEANING TEMPORARY FILES"
rm -f "$MODULE_ZIP"
rm -rf "$UNZIP_DIR" 
rm -f "$QFIRE" 

if [ "$FLASH_EXIT_CODE" -eq 0 ]; then
    echo "‚úÖ Module Updated Successfully!! Device will reboot in 5 seconds."
    sleep 5
    reboot
else
    echo "‚ö†Ô∏è ERROR: Flashing failed (exit code $FLASH_EXIT_CODE). Check log for details."
fi

# Remove this script itself upon completion
rm -f "$0"
